<!DOCTYPE html>
<html>
 <head>
   <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
   <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js"></script>
   <script src="https://unpkg.com/aframe-particle-system-component@1.1.0/dist/aframe-particle-system-component.min.js"></script>
 
   <style>
      /* ESTILOS DA TELA DE INTRODUÇÃO */
      #splash-screen {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: #333;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          color: white;
          text-align: center;
      }
      #start-button {
          padding: 15px 30px;
          font-size: 1.2em;
          cursor: pointer;
          background-color: #007bff;
          border: none;
          border-radius: 5px;
          color: white;
          margin-top: 20px;
      }
      #minha-cena {
          display: none; 
      }
   </style>
</head>
 <body>
 
  <div id="splash-screen">
      <h1>Realidade Aumentada Pronta</h1>
      <p>É necessário um toque para iniciar a câmera e o áudio.</p>
      <button id="start-button">Tocar para Iniciar RA</button>
  </div>

  <a-scene
      id="minha-cena" 
      mindar-image="imageTargetSrc: markers/targets.mind; maxTrack: 1;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
     >

     <a-assets>
         <audio id="musica-target-0" src="musicas/natal.mp3" preload="auto"></audio>
         <audio id="musica-target-1" src="musicas/natal.mp3" preload="auto"></audio>
         <audio id="musica-target-2" src="musicas/natal.mp3" preload="auto"></audio>
     </a-assets>

     <a-camera position="0 0 -5" look-controls="enabled: false"></a-camera>

     <a-entity mindar-image-target="targetIndex: 0" id="target-0">
     <a-entity id="wrap-0"></a-entity>
     <a-entity id="sound-0"></a-entity>
     </a-entity>

     <a-entity mindar-image-target="targetIndex: 1" id="target-1">
     <a-entity id="wrap-1"></a-entity>
     <a-entity id="sound-1"></a-entity>
     </a-entity>

     <a-entity mindar-image-target="targetIndex: 2" id="target-2">
     <a-entity id="wrap-2"></a-entity>
     <a-entity id="sound-2"></a-entity>
     </a-entity>

   </a-scene>

   <script>
   
   // --- PASSO 1: DEFINIÇÃO DO COMPONENTE OTIMIZADO (color-cycle-opt) ---
   AFRAME.registerComponent('color-cycle-opt', {
     schema: {
       // Incluímos '#000000' (Preto) para o estado "Cor Original"
       colors: {type: 'array', default: ['#ff0000', '#00ff00', '#0000ff'], parse: AFRAME.utils.styleParser.toArray},
       interval: {type: 'number', default: 5000} 
     },
     init: function () {
       this.colorIndex = 0;
       this.materials = []; 
       this.intervalId = null;
       this.el.addEventListener('model-loaded', this.setupMaterials.bind(this));
     },
     setupMaterials: function () {
       const model = this.el.getObject3D('mesh'); 
       if (!model) return;
       this.materials = []; 
       model.traverse((node) => {
         if (node.isMesh && node.material) {
           const nodeMaterials = Array.isArray(node.material) ? node.material : [node.material];
           this.materials.push(...nodeMaterials);
         }
       });
       if (this.intervalId) {
           clearInterval(this.intervalId);
       }
       this.intervalId = setInterval(this.cycleColor.bind(this), this.data.interval);
       this.cycleColor();
       console.log(`Ciclo de cor iniciado com ${this.materials.length} materiais.`);
     },
     cycleColor: function () {
       if (this.materials.length === 0) return;
       
       const newColor = this.data.colors[this.colorIndex];

       this.materials.forEach(material => {
           // Se for a cor preta, desligamos a emissão para mostrar a cor original
           if (newColor === '#000000') {
               material.emissive.set(0x000000); 
               material.emissiveIntensity = 0; 
           } else {
               // Aplicamos a cor emissiva normalmente
               material.emissive.set(newColor);
               material.emissiveIntensity = 1; 
           }
       });

       this.colorIndex = (this.colorIndex + 1) % this.data.colors.length;
     },
     remove: function () {
       if (this.intervalId) {
           clearInterval(this.intervalId);
       }
     }
   });
   
   // --- PASSO 2: DADOS E VARIÁVEIS DA CENA ---
   const modelos = {
   0: { 
       src: "models/bonecoNeve.glb", 
       img: "images/cartao.jpeg", 
       audio: "#musica-target-0" // ID de áudio atualizado
   }, 
   1: { 
        src: "models/arvoreNatal.glb", 
        img: "images/cartao.jpeg", 
        audio: "#musica-target-1" // ID de áudio atualizado
   }, 
   2: { 
        src: "models/presente.glb", 
        img: "images/cartao.jpeg", 
        audio: "#musica-target-2" // ID de áudio atualizado
   }, 
   };

   const planeSettings = {
   width: 1.1, height: 1.5, position: "0 0 0", rotation: "0 0 0", material: "shader: flat; transparent: true; opacity: 1", 
   };

   const scene = document.querySelector("#minha-cena");
   
   // --- PASSO 3: CONFIGURAÇÃO DE SOM INICIAL (PRÉ-CARREGAMENTO) ---
   Object.keys(modelos).forEach((index) => {
       const soundEntity = document.querySelector(`#sound-${index}`);
       const audioSrc = modelos[index].audio;
       
       soundEntity.setAttribute("sound", {
           src: audioSrc,            
           loop: true,               
           autoplay: false,          
           positional: false,
           volume: 0 // Inicia MUDO para controle posterior
       });
   });

   // --- PASSO 4: LÓGICA DE SPLASH SCREEN E LIBERAÇÃO DO ÁUDIO ---
   const startButton = document.querySelector('#start-button');
   const splashScreen = document.querySelector('#splash-screen');

   startButton.addEventListener('click', () => {
       // Libera o Áudio (interação do clique)
       Object.keys(modelos).forEach((index) => {
            const soundEntity = document.querySelector(`#sound-${index}`);
            if (soundEntity.components.sound) {
               soundEntity.setAttribute('sound', 'volume', 0); // Garante que comece mudo
               soundEntity.components.sound.playSound();      // Libera e toca (em loop mudo)
            }
       });

       // Inicia a RA
       splashScreen.style.display = 'none';
       scene.style.display = 'block';
       scene.emit('startAR'); 
   });


   // --- PASSO 5: LÓGICA DE RASTREAMENTO (targetFound/targetLost) ---
   Object.keys(modelos).forEach((index) => {
   const target = document.querySelector(`#target-${index}`);
   const wrap = document.querySelector(`#wrap-${index}`);

   target.addEventListener("targetFound", () => {
   
     if (!wrap.hasChildNodes()) {
       const { src: modelSrc, img: imgSrc } = modelos[index];

       // Cria o plano
       const plane = document.createElement("a-plane");
       plane.setAttribute("src", `url(${imgSrc})`);
       plane.setAttribute("width", planeSettings.width);
       plane.setAttribute("height", planeSettings.height);
       plane.setAttribute("position", planeSettings.position);
       plane.setAttribute("rotation", planeSettings.rotation);
       plane.setAttribute("material", planeSettings.material);

       // Cria o Modelo 3D
       const model = document.createElement("a-gltf-model");
       model.setAttribute("src", `url(${modelSrc})`);
       model.setAttribute("scale", "0.6 0.6 0.2");
       model.setAttribute("position", "0 0.1 0.1"); 
       model.setAttribute("rotation", "90 0 0");
       model.setAttribute("animation-mixer", "clip: *; loop: repeat");
       
       // Aplica a lógica do ciclo de cores apenas ao Target 1 (Árvore de Natal, conforme o seu último mapa de modelos)
       if (index === '1') {
           model.setAttribute("color-cycle-opt", {
               // Cores: Vermelho, Azul, e Preto (estado Original)
               colors: ['#FF0000', '#0000FF', '#000000'], 
               interval: 5000 // 5 segundos
           });
           console.log("Ciclo de cores aplicado à Árvore de Natal (Target 1).");
       }

       wrap.appendChild(plane);
       wrap.appendChild(model);
     } 

     // Reproduz o Som: Apenas aumenta o volume para 1 (o som já está em loop)
     wrap.setAttribute("visible", "true");
     const soundEntity = document.querySelector(`#sound-${index}`);
     if (soundEntity && soundEntity.components.sound) {
       soundEntity.setAttribute('sound', 'volume', 1); // Ativa o volume
     }
   });

   target.addEventListener("targetLost", () => {
     // Pausa o Som: Apenas zera o volume
     const soundEntity = document.querySelector(`#sound-${index}`);
     if (soundEntity && soundEntity.components.sound) {
       soundEntity.setAttribute('sound', 'volume', 0); // Volta para Mudo
     }
     
     // Esconde o Container
     wrap.setAttribute("visible", "false");
    });
   });
  </script>
 </body>
</html>